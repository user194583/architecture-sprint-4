## **1. Мотивация**

**Почему нужно логирование?**  
Сейчас разбор ошибок и нестандартных ситуаций происходит со слов клиентов, что требует значительных временных затрат от разработчиков и поддержки. Это приводит:
- Долгому устранению проблем.
- Недовольству клиентов из-за задержек в обработке запросов.
- Невозможности оперативно анализировать причины сбоев.

**Что даст логирование компании?**  
1. **Ускорение разбора проблем:**  
   - Логи позволят быстро находить корневые причины ошибок.
   - Снизится нагрузка на поддержку, так как не нужно будет опрашивать клиентов.
2. **Повышение прозрачности работы системы:**  
   - Логирование ключевых событий (например, изменение статуса заказа) даст полную картину работы системы.
   - Упростится взаимодействие между командами (разработка, поддержка, продажи).
3. **Улучшение качества сервиса:**  
   - Возможность выявлять и устранять проблемы до того, как они повлияют на клиентов.
   - Снижение количества жалоб и потери контрактов.
4. **Поддержка масштабирования:**  
   - Логирование поможет анализировать нагрузку на систему и планировать её масштабирование.

**Технические и бизнес-метрики, на которые повлияет логирование:**
- **Время устранения инцидентов.**
- **Количество жалоб клиентов.**
- **Удовлетворённость клиентов.**
- **Количество ошибок в системе.**
- **Скорость обработки заказов.**

---

## **2. Предлагаемое решение**

### **2.1. Логирование**
**Какие логи собирать:**
1. **API (интернет-магазин, CRM, MES):**
   - Запросы и ответы (уровень INFO):  
     - Время запроса.  
     - Идентификатор пользователя.  
     - Номер заказа (если применимо).  
     - HTTP-метод и endpoint.  
     - Статус ответа (200, 500 и т.д.).  
   - Ошибки (уровень ERROR):  
     - Текст ошибки.  
     - Стек вызовов.  
     - Контекст запроса (параметры, заголовки).  

2. **RabbitMQ:**
   - Сообщения в dead-letter-exchange (уровень WARN).  
   - Ошибки обработки сообщений (уровень ERROR).  

3. **Базы данных:**
   - Медленные запросы (уровень WARN).  
   - Ошибки выполнения запросов (уровень ERROR).  

4. **Производство (MES):**
   - Изменение статуса заказа (уровень INFO):  
     - Время изменения.  
     - Идентификатор заказа.  
     - Новый статус.  
   - Ошибки расчёта стоимости (уровень ERROR).  

5. **Пользовательские действия:**
   - Создание, изменение, удаление заказа (уровень INFO).  
   - Авторизация и аутентификация (уровень INFO).  

**Уровни логирования:**
- **INFO:** Для стандартных событий (например, изменение статуса заказа).  
- **WARN:** Для нестандартных ситуаций (например, медленные запросы).  
- **ERROR:** Для критических ошибок (например, сбои в API).  

### **2.2. Трейсинг**
Трейсинг будет использоваться для отслеживания цепочки запросов между системами (например, от интернет-магазина до MES). Это поможет:
- Выявлять узкие места в системе.
- Анализировать время выполнения каждого этапа.

---

## **3. Политика безопасности и хранения логов**

### **3.1. Безопасность**
- **Чувствительные данные:**  
  - Логи не должны содержать пароли, номера кредитных карт и другие чувствительные данные.  
  - Конфиденциальные данные (например, email) должны маскироваться.  
- **Доступ к логам:**  
  - Только авторизованные сотрудники (разработчики, поддержка, аналитики).  
  - Доступ через VPN или защищённое соединение.  

### **3.2. Хранение**
- **Срок хранения:**  
  - Логи хранятся 30 дней для оперативного анализа.  
  - Архивные логи хранятся 1 год для аудита и анализа трендов.  
- **Размер логов:**  
  - Логи будут храниться в индексах Elasticsearch, размер которых ограничен 100 ГБ на систему.  
  - Старые логи будут архивироваться в S3.  

---

## **4. План действий**

### **4.1. Приоритетные системы для логирования и трейсинга**
1. **API интернет-магазина:**  
   - Это основной канал взаимодействия с клиентами.  
   - Логирование поможет быстро выявлять проблемы с заказами.  
2. **MES:**  
   - Критическая система для производства.  
   - Логирование поможет анализировать задержки в расчёте стоимости.  
3. **RabbitMQ:**  
   - Интеграция между CRM и MES.  
   - Логирование поможет выявлять потери сообщений.  

### **4.2. Технологии**
- **Логирование:**  
  - Использование ELK-стека (Elasticsearch, Logstash, Kibana).  
  - Логи будут собираться через Filebeat и отправляться в Elasticsearch.  
- **Трейсинг:**  
  - Использование Jaeger для распределённого трейсинга.  
  - Интеграция с API и RabbitMQ.  

### **4.3. Алертинг и анализ аномалий**
- **Алертинг:**  
  - Настроить алерты в Kibana для критических ошибок (например, HTTP 500).  
  - Алерты будут отправляться в Slack/Telegram.  
- **Анализ аномалий:**  
  - Использование Machine Learning в Elasticsearch для выявления аномалий (например, резкий рост числа заказов).  
  - Настройка правил для обнаружения DDoS-атак.  

---

## **5. Ожидаемые результаты**

1. **Снижение времени устранения инцидентов (MTTR):**  
   - Проблемы будут выявляться и устраняться быстрее.  
2. **Улучшение качества сервиса:**  
   - Снизится количество жалоб клиентов.  
3. **Повышение прозрачности работы системы:**  
   - Команды смогут оперативно анализировать данные.  
4. **Подготовка к масштабированию:**  
   - Логирование и трейсинг помогут выявлять узкие места и планировать рост.  

