### Архитектурное решение по трейсингу

---

## **1. Мотивация**

**Почему нужен трейсинг?**  
В текущей системе заказы часто зависают или теряются, что приводит к:
- Недовольству клиентов из-за задержек.
- Увеличению нагрузки на поддержку, так как приходится вручную разбирать проблемы.
- Потере контрактов из-за невыполненных заказов.

**Что даст трейсинг компании?**
1. **Прозрачность работы системы:**  
   - Возможность отслеживать путь заказа через все сервисы.  
   - Быстрое выявление узких мест и зависших заказов.  
2. **Ускорение разбора проблем:**  
   - Снижение времени на поиск и устранение ошибок.  
   - Уменьшение нагрузки на поддержку.  
3. **Улучшение качества сервиса:**  
   - Снижение количества жалоб клиентов.  
   - Повышение удовлетворённости клиентов.  

**Технические и бизнес-метрики, на которые повлияет трейсинг:**
- **Время устранения инцидентов.**
- **Количество потерянных заказов.**
- **Удовлетворённость клиентов.**
- **Количество ошибок в системе.**
- **Скорость обработки заказов.**

---

## **2. Предлагаемое решение**

### **2.1. Системы, которые следует покрыть трейсингом**
1. **Интернет-магазин:**  
   - Создание заказа.  
   - Отправка заказа в CRM.  
2. **CRM:**  
   - Обработка заказа.  
   - Отправка заказа в MES через RabbitMQ.  
3. **RabbitMQ:**  
   - Передача сообщений между CRM и MES.  
4. **MES:**  
   - Расчёт стоимости заказа.  
   - Изменение статуса заказа.  

### **2.2. Данные для трейсинга**
- **Идентификатор заказа.**  
- **Временные метки:**  
  - Время создания заказа.  
  - Время обработки на каждом этапе.  
- **Статус заказа на каждом этапе.**  
- **Ошибки (если возникают):**  
  - Текст ошибки.  
  - Стек вызовов.  

### **2.3. Технологии**
- **Инструмент трейсинга:** Jaeger.  
- **Интеграция:**  
  - Использование OpenTelemetry для сбора трейсов.  
  - Интеграция с API интернет-магазина, CRM, RabbitMQ и MES.  
- **Визуализация:**  
  - Дашборды в Grafana для отображения трейсов.  

### **2.4. Доработанная диаграмма контейнеров**

[Ссылка на доработанную диаграмму C4](https://github.com/user194583/architecture-sprint-4/blob/sprint4/Exc3/jewerly_c4_model.drawio)  

[Ссылка на доработанную диаграмму C4 PNG](https://github.com/user194583/architecture-sprint-4/blob/sprint4/Exc3/jewerly_c4_model.png)  

(На диаграмме выделены красным новые компоненты: Jaeger, Grafana.)

---

## **3. Компромиссы**

1. **Проприетарные системы:**  
   - Некоторые системы (например, RabbitMQ) могут не поддерживать OpenTelemetry из коробки.  
   - Решение: Использование адаптеров или ручная интеграция.  

2. **Высокая нагрузка на систему:**  
   - Трейсинг может увеличить нагрузку на систему.  
   - Решение: Настройка выборки (sampling) для уменьшения объёма данных.  

3. **Сложность внедрения:**  
   - Интеграция трейсинга требует времени и ресурсов.  
   - Решение: Поэтапное внедрение, начиная с критических систем.  

---

## **4. Аспекты безопасности**

1. **Аутентификация:**  
   - Доступ к Jaeger и Grafana только для авторизованных сотрудников.  

2. **Ролевая модель:**  
   - Роли «Поддержка», «Разработка», «Аналитика» с разным уровнем доступа.  

3. **Шифрование данных:**  
   - Все данные трейсинга передаются по защищённым каналам (HTTPS, TLS).  

4. **Ограничение доступа:**  
   - Jaeger и Grafana доступны только из внутренней сети компании.  

---

## **5. План действий**

1. **Выбор инструментов:**  
   - Установка Jaeger и OpenTelemetry.  
   - Настройка Grafana для визуализации.  

2. **Интеграция с системами:**  
   - Внедрение OpenTelemetry в API интернет-магазина, CRM, RabbitMQ и MES.  

3. **Настройка выборки данных:**  
   - Установка правил для уменьшения объёма данных (например, 10% запросов).  

4. **Тестирование и запуск:**  
   - Проведение нагрузочного тестирования.  

5. **Мониторинг и оптимизация:**  
   - Настройка алертов для критических ошибок.  
   - Постоянная оптимизация системы трейсинга.  

---

## **6. Ожидаемые результаты**

1. **Прозрачность работы системы:**  
   - Возможность отслеживать путь заказа через все сервисы.  
2. **Ускорение разбора проблем:**  
   - Снижение времени на поиск и устранение ошибок.  
3. **Улучшение качества сервиса:**  
   - Снижение количества жалоб клиентов.  
4. **Подготовка к масштабированию:**  
   - Трейсинг поможет выявлять узкие места и планировать рост.  

