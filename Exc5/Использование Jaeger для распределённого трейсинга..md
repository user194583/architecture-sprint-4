### Архитектурное решение по кешированию

---

## **1. Мотивация**

**Почему нужно кеширование?**  
MES испытывает проблемы с производительностью, что негативно влияет на работу операторов и удовлетворённость клиентов:
- Операторы жалуются на медленную загрузку страницы со списком заказов.
- Клиенты недовольны задержками в выполнении заказов.
- Увеличение нагрузки на систему (рост числа заказов) усугубляет ситуацию.

**Какие проблемы решит кеширование?**
1. **Ускорение работы операторов:**  
   - Быстрая загрузка списка заказов.  
   - Уменьшение времени отклика при изменении статуса заказа.  
2. **Улучшение пользовательского опыта:**  
   - Снижение задержек при выполнении заказов.  
   - Повышение удовлетворённости клиентов.  
3. **Снижение нагрузки на базу данных:**  
   - Уменьшение количества запросов к базе данных.  
   - Повышение стабильности системы.  

**Какие элементы системы будут закешированы:**
- **Список заказов:** Часто запрашиваемые данные, которые редко меняются.  
- **Статусы заказов:** Данные, которые часто обновляются, но редко читаются.  
- **Расчёт стоимости:** Результаты сложных вычислений, которые можно кешировать на короткое время.  

---

## **2. Предлагаемое решение**

### **2.1. Тип кеширования**
**Серверное кеширование:**  
- **Почему серверное?**  
  - Клиентское кеширование не подходит, так как данные должны быть актуальными для всех пользователей (операторов и клиентов).  
  - Серверное кеширование позволяет централизованно управлять данными и обеспечивать их актуальность.  

**Паттерн кеширования: Cache-Aside**  
- **Почему Cache-Aside?**  
  - **Преимущества:**  
    - Простота реализации.  
    - Гибкость: данные кешируются только при необходимости.  
    - Уменьшение нагрузки на базу данных.  
  - **Почему не другие паттерны?**  
    - **Write-Through:** Требует синхронной записи в кеш и базу данных, что увеличивает задержку.  
    - **Refresh-Ahead:** Сложность реализации и избыточность для текущих потребностей.  

### **2.2. Диаграмма последовательности**

```plaintext
Оператор -> MES: Запрос списка заказов
MES -> Кеш: Проверка наличия данных
alt Данные есть в кеше
    Кеш -> MES: Возврат данных
else Данных нет в кеше
    MES -> База данных: Запрос данных
    База данных -> MES: Возврат данных
    MES -> Кеш: Сохранение данных
end
MES -> Оператор: Возврат списка заказов

Оператор -> MES: Изменение статуса заказа
MES -> База данных: Обновление статуса
MES -> Кеш: Инвалидация данных
База данных -> MES: Подтверждение обновления
MES -> Оператор: Подтверждение изменения статуса
```

![Alt tesxt](cache_seq_diag.png?raw=true "Диаграмма")

### **2.3. Стратегия инвалидации кеша**
**Временная инвалидация (TTL):**  
- **Почему временная?**  
  - Простота реализации.  
  - Подходит для данных, которые не требуют мгновенной актуальности (например, список заказов).  
  - Уменьшает нагрузку на систему.  

**Инвалидация по ключу:**  
- **Почему по ключу?**  
  - Для данных, которые часто обновляются (например, статус заказа).  
  - Обеспечивает актуальность данных при изменении.  

**Почему не другие стратегии?**  
- **Программная инвалидация:** Сложность реализации и поддержки.  
- **Полная инвалидация:** Неэффективна для больших объёмов данных.  

---

## **3. Сравнительный анализ стратегий инвалидации**

| **Временная инвалидация (TTL)**       | **Инвалидация по ключу**               | **Программная инвалидация**           |
|---------------------------------------|----------------------------------------|---------------------------------------|
| **Лучше подходит, потому что:**       | **Лучше подходит, потому что:**        | **Не подходит, потому что:**          |
| - Простота реализации.                | - Обеспечивает актуальность данных.    | - Сложность реализации.               |
| - Уменьшает нагрузку на систему.      | - Подходит для часто обновляемых данных.| - Требует постоянного контроля.       |
| **Есть особенности:**                 | **Есть особенности:**                  | **Не позволяет сделать:**             |
| 1) Не требует сложной логики.         | 1) Требует управления ключами.         | 1) Автоматическую инвалидацию.        |
| 2) Подходит для редко меняющихся данных.| 2) Подходит для критически важных данных.| 2) Эффективное управление кешем.      |

---

## **4. План действий**

1. **Выбор инструмента кеширования:**  
   - Использование Redis как высокопроизводительного решения для кеширования.  

2. **Реализация Cache-Aside:**  
   - Настройка кеширования списка заказов и статусов.  
   - Интеграция Redis с MES.  

3. **Настройка стратегии инвалидации:**  
   - Временная инвалидация для списка заказов (TTL = 5 минут).  
   - Инвалидация по ключу для статусов заказов.  

4. **Тестирование и мониторинг:**  
   - Проведение нагрузочного тестирования.  
   - Настройка мониторинга кеша (например, через Prometheus и Grafana).  

---

## **5. Ожидаемые результаты**

1. **Ускорение работы операторов:**  
   - Загрузка списка заказов займёт менее 1 секунды.  
2. **Улучшение пользовательского опыта:**  
   - Снижение задержек при выполнении заказов.  
3. **Снижение нагрузки на базу данных:**  
   - Уменьшение количества запросов на 50%.  
4. **Повышение стабильности системы:**  
   - Уменьшение времени простоя и количества ошибок.  

