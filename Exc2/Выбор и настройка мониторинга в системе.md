## 1.Мотивация
   
### Почему нужен мониторинг?

Система «Александрит» стала сложнее: появились новые компоненты (API для сторонних продавцов, интеграция CRM и MES через RabbitMQ), а нагрузка на систему растёт. Яндекс Метрика не охватывает все аспекты работы системы, особенно API и внутренние процессы. Это приводит к следующим проблемам:

- Невозможно оперативно выявлять узкие места в системе.

- Задержки в обработке заказов и сбои обнаруживаются только после жалоб клиентов.

- Нет данных для анализа производительности системы и планирования масштабирования.

### Что даст мониторинг компании?

1.Улучшение отказоустойчивости:

- Раннее обнаружение сбоев и узких мест.

- Снижение количества жалоб клиентов и потери контрактов.

2.Оптимизация производительности:

- Выявление медленных компонентов системы (например, долгий расчёт стоимости в MES).

- Возможность планировать масштабирование на основе реальных данных.

3.Прозрачность работы системы:

- Понимание нагрузки на каждый компонент (API, базы данных, RabbitMQ).

- Улучшение взаимодействия между командами (разработка, поддержка, продажи).

4.Экономия ресурсов:

- Снижение времени на поиск и устранение проблем.

- Возможность предотвращать сбои, а не реагировать на них.

## 2.Выбор подхода к мониторингу
Для разных частей системы будут использоваться разные подходы:

- USE (Utilization, Saturation, Errors) — для инфраструктуры (серверы, базы данных, RabbitMQ).
Этот подход поможет отслеживать использование ресурсов (CPU, память, диски) и выявлять перегрузку.

- RED (Rate, Errors, Duration) — для API (интернет-магазин, CRM, MES).
Этот подход подходит для мониторинга запросов, ошибок и времени ответа.

- Четыре золотых сигнала (Traffic, Errors, Latency, Saturation) — для комплексного мониторинга всей системы.
Этот подход объединяет USE и RED, что позволяет получить полную картину.

## 3.Метрики для мониторинга
### 3.1. RabbitMQ
- #### Number of dead-letter-exchange letters in RabbitMQ
  #### Зачем: Для выявления сообщений, которые не удалось обработать.
  #### Ярлыки: queue_name, error_type.

- #### Number of messages in flight in RabbitMQ
  #### Зачем: Для оценки текущей нагрузки на очередь.
  #### Ярлыки: queue_name.

### 3.2. API (интернет-магазин, CRM, MES)
- #### Number of requests (RPS) for internet shop API / CRM API / MES API
- #### Зачем: Для оценки нагрузки на каждый API.
- #### Ярлыки: endpoint, http_method.

- #### Response time (latency) for shop API / CRM API / MES API
  #### Зачем: Для выявления медленных запросов.
  #### Ярлыки: endpoint, http_method.

- #### Number of HTTP 200 for shop API / CRM API / MES API
  #### Зачем: Для оценки успешности запросов.
  #### Ярлыки: endpoint, http_method.

- #### Number of HTTP 500 for shop API / CRM API / MES API
  #### Зачем: Для выявления ошибок на стороне сервера.
  #### Ярлыки: endpoint, http_method.

- #### Number of simultaneous sessions for shop API / CRM API / MES API
  #### Зачем: Для оценки активности пользователей.
  #### Ярлыки: user_type (B2C, B2B).

### 3.3. Инфраструктура
- #### CPU % for shop API / CRM API / MES API
  #### Зачем: Для выявления перегрузки серверов.
  #### Ярлыки: instance_id.

- #### Memory Utilisation for shop API / CRM API / MES API
  #### Зачем: Для контроля использования памяти.
  #### Ярлыки: instance_id.

- #### Number of connections for shop db instance / MES db instance
  #### Зачем: Для оценки нагрузки на базы данных.
  #### Ярлыки: database_name.

### 3.4. Хранение данных
- #### Size of S3 storage
  #### Зачем: Для контроля использования хранилища.
  #### Ярлыки: bucket_name.

- #### Size of shop db instance / MES db instance
  #### Зачем: Для контроля роста баз данных.
  #### Ярлыки: database_name.

### 3.5. Сеть
- #### Kb transferred (received) for shop API / CRM API / MES API
  #### Зачем: Для оценки входящего трафика.
  #### Ярлыки: endpoint.

- #### Kb provided (sent) for shop API / CRM API / MES API
  #### Зачем: Для оценки исходящего трафика.
  #### Ярлыки: endpoint.

## 4.План действий
1.Выбор инструментов мониторинга:

- Внедрить Prometheus для сбора метрик и Alertmanager для уведомлений.

- Использовать Grafana для визуализации данных.

2.Настройка сбора метрик:

- Развернуть экспортеры для RabbitMQ, баз данных и API (например, Node Exporter для серверов, RabbitMQ Exporter, PostgreSQL Exporter).

- Настроить сбор метрик для каждого компонента системы.

3.Создание дашбордов в Grafana:

- Разработать дашборды для мониторинга API, RabbitMQ, баз данных и инфраструктуры.

- Настроить алерты для критических метрик (например, высокий CPU, ошибки 500, dead-letter-сообщения).

4.Интеграция с существующими системами:

- Настроить интеграцию Prometheus с CRM и MES для сбора кастомных метрик.

- Обеспечить передачу уведомлений в Slack/Telegram для оперативного реагирования.

5.Тестирование и запуск:

- Провести нагрузочное тестирование системы с включённым мониторингом.

## 5. Ожидаемые результаты
1.Снижение времени простоя:

- Проблемы будут выявляться до того, как они повлияют на клиентов.

2.Улучшение производительности:

- Появится возможность оптимизировать медленные компоненты.

3.Повышение удовлетворённости клиентов:

- Снизится количество жалоб на задержки и сбои.

4.Экономия ресурсов:

- Команда сможет быстрее устранять проблемы и предотвращать их.
